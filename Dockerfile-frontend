# DOCKER_BUILDKIT=0 docker build -f Dockerfile-frontend .
FROM docker.io/sbtscala/scala-sbt:eclipse-temurin-jammy-19.0.1_10_1.8.2_3.2.2 AS sbt
WORKDIR /app
COPY . .
RUN sbt fullLinkJS

FROM docker.io/library/node AS npm
ARG VITE_ALWAYS_ONLINE_PEER_PROTOCOL
ARG VITE_ALWAYS_ONLINE_PEER_HOST
ARG VITE_ALWAYS_ONLINE_PEER_PUBLIC_PORT
ARG VITE_DISCOVERY_SERVER_PROTOCOL
ARG VITE_DISCOVERY_SERVER_HOST
ARG VITE_DISCOVERY_SERVER_PORT
ARG VITE_DISCOVERY_SERVER_WEBSOCKET_PROTOCOL
ARG VITE_DISCOVERY_SERVER_WEBSOCKET_HOST
ARG VITE_DISCOVERY_SERVER_WEBSOCKET_PORT
ARG VITE_TURN_SERVER_HOST
ARG VITE_TURN_SERVER_PORT
WORKDIR /app
COPY --from=sbt /app /app
RUN npm ci
RUN VITE_ALWAYS_ONLINE_PEER_PROTOCOL=$VITE_ALWAYS_ONLINE_PEER_PROTOCOL \
    VITE_ALWAYS_ONLINE_PEER_HOST=$VITE_ALWAYS_ONLINE_PEER_HOST \
    VITE_ALWAYS_ONLINE_PEER_PUBLIC_PORT=$VITE_ALWAYS_ONLINE_PEER_PUBLIC_PORT \
    VITE_DISCOVERY_SERVER_PROTOCOL=$VITE_DISCOVERY_SERVER_PROTOCOL \
    VITE_DISCOVERY_SERVER_HOST=$VITE_DISCOVERY_SERVER_HOST \
    VITE_DISCOVERY_SERVER_PORT=$VITE_DISCOVERY_SERVER_PORT \
    VITE_DISCOVERY_SERVER_WEBSOCKET_PROTOCOL=$VITE_DISCOVERY_SERVER_WEBSOCKET_PROTOCOL \
    VITE_DISCOVERY_SERVER_WEBSOCKET_HOST=$VITE_DISCOVERY_SERVER_WEBSOCKET_HOST \
    VITE_DISCOVERY_SERVER_WEBSOCKET_PORT=$VITE_DISCOVERY_SERVER_WEBSOCKET_PORT \
    VITE_TURN_SERVER_HOST=$VITE_TURN_SERVER_HOST \
    VITE_TURN_SERVER_PORT=$VITE_TURN_SERVER_PORT \
    npm run build

FROM docker.io/library/nginx
WORKDIR /app
# TODO FIXME we don't need a template, we could directly put the config there
COPY --from=npm /app/dist /app/dist
