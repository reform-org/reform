# DOCKER_BUILDKIT=0 docker build -f Dockerfile-frontend .
FROM sbtscala/scala-sbt:eclipse-temurin-jammy-19.0.1_10_1.8.2_3.2.2 AS sbt
WORKDIR /app
COPY . .
RUN sbt fullLinkJS

FROM node AS npm
ARG VITE_ALWAYS_ONLINE_PEER_URL
ARG VITE_DISCOVERY_SERVER_URL
ARG VITE_DISCOVERY_SERVER_WEBSOCKET_URL
ARG VITE_TURN_SERVER
WORKDIR /app
COPY --from=sbt /app /app
RUN npm ci
RUN VITE_ALWAYS_ONLINE_PEER_URL=${VITE_ALWAYS_ONLINE_PEER_URL} VITE_DISCOVERY_SERVER_URL=${VITE_DISCOVERY_SERVER_URL} VITE_DISCOVERY_SERVER_WEBSOCKET_URL=${VITE_DISCOVERY_SERVER_WEBSOCKET_URL} VITE_TURN_SERVER=${VITE_TURN_SERVER} npm run build

FROM nginx
WORKDIR /app
# TODO FIXME we don't need a template, we could directly put the image there
RUN cat /etc/nginx/nginx.conf
RUN ls /etc/nginx/conf.d/
RUN cat /etc/nginx/conf.d/*.conf
COPY --from=npm /app/dist /app/dist
